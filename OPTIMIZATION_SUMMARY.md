# OAç³»ç»Ÿä¼˜åŒ–æ€»ç»“

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. Activity Logs è‡ªåŠ¨æ¸…ç† ğŸ”´ é«˜ä¼˜å…ˆçº§

**å®ç°å†…å®¹ï¼š**
- åˆ›å»ºäº† `activity-logs:clean` å‘½ä»¤
- é…ç½®äº†å®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ¸…ç†90å¤©å‰çš„æ—¥å¿—
- ä¿ç•™æœ€è¿‘90å¤©çš„æ´»åŠ¨æ—¥å¿—

**å‘½ä»¤ä½ç½®ï¼š**
- `app/Console/Commands/CleanOldActivityLogs.php`
- å®šæ—¶ä»»åŠ¡é…ç½®åœ¨ `bootstrap/app.php`

**æ‰‹åŠ¨æ‰§è¡Œï¼š**
```bash
php artisan activity-logs:clean --days=90
```

**å®šæ—¶ä»»åŠ¡ï¼š**
- æ‰§è¡Œæ—¶é—´ï¼šæ¯å¤© 02:00 (Asia/Shanghai)
- è‡ªåŠ¨æ¸…ç†90å¤©å‰çš„æ—¥å¿—
- æ— éœ€äººå·¥å¹²é¢„

### 2. PHP é…ç½®ä¼˜åŒ– âœ…

**ä¿®æ”¹å†…å®¹ï¼š**

| é…ç½®é¡¹ | åŸå€¼ | æ–°å€¼ | è¯´æ˜ |
|--------|------|------|------|
| `memory_limit` | 128M | **256M** | å¢åŠ å†…å­˜é™åˆ¶ï¼Œé¿å…å†…å­˜ä¸è¶³ |
| `max_execution_time` | 30ç§’ | **300ç§’** | å¢åŠ æ‰§è¡Œæ—¶é—´ï¼Œæ”¯æŒé•¿æ—¶é—´æ“ä½œ |
| `post_max_size` | 8M | **20M** | å¢åŠ POSTæ•°æ®å¤§å°é™åˆ¶ |
| `upload_max_filesize` | 2M | **10M** | å¢åŠ æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶ |

**é…ç½®æ–‡ä»¶ï¼š**
- `/etc/php/8.3/fpm/php.ini`

**ç”Ÿæ•ˆæ–¹å¼ï¼š**
- å·²é‡æ–°åŠ è½½ PHP-FPM æœåŠ¡
- æ–°é…ç½®å·²ç”Ÿæ•ˆ

### 3. PHP-FPM è¿›ç¨‹é…ç½®ä¼˜åŒ– âœ…

**ä¿®æ”¹å†…å®¹ï¼š**

| é…ç½®é¡¹ | åŸå€¼ | æ–°å€¼ | è¯´æ˜ |
|--------|------|------|------|
| `pm.max_children` | 5 | **10** | æœ€å¤§å­è¿›ç¨‹æ•°ï¼Œæé«˜å¹¶å‘å¤„ç†èƒ½åŠ› |
| `pm.start_servers` | 2 | **3** | å¯åŠ¨æ—¶çš„è¿›ç¨‹æ•° |
| `pm.min_spare_servers` | 1 | **2** | æœ€å°ç©ºé—²è¿›ç¨‹æ•° |
| `pm.max_spare_servers` | 3 | **5** | æœ€å¤§ç©ºé—²è¿›ç¨‹æ•° |

**é…ç½®æ–‡ä»¶ï¼š**
- `/etc/php/8.3/fpm/pool.d/www.conf`

**ç”Ÿæ•ˆæ–¹å¼ï¼š**
- å·²é‡æ–°åŠ è½½ PHP-FPM æœåŠ¡
- æ–°é…ç½®å·²ç”Ÿæ•ˆ

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### æ€§èƒ½æå‡
- âœ… å¹¶å‘å¤„ç†èƒ½åŠ›æå‡ 100%ï¼ˆä»5ä¸ªè¿›ç¨‹å¢åŠ åˆ°10ä¸ªï¼‰
- âœ… å†…å­˜é™åˆ¶æå‡ 100%ï¼ˆä»128Må¢åŠ åˆ°256Mï¼‰
- âœ… æ–‡ä»¶ä¸Šä¼ é™åˆ¶æå‡ 400%ï¼ˆä»2Må¢åŠ åˆ°10Mï¼‰

### èµ„æºç®¡ç†
- âœ… Activity Logs è‡ªåŠ¨æ¸…ç†ï¼Œé˜²æ­¢æ— é™å¢é•¿
- âœ… ç³»ç»Ÿèµ„æºä½¿ç”¨æ›´åŠ åˆç†
- âœ… é™ä½é•¿æœŸè¿è¡Œé£é™©

## ğŸ”§ ç»´æŠ¤å»ºè®®

### å®šæœŸæ£€æŸ¥ï¼ˆæ¯æœˆï¼‰
1. æ£€æŸ¥ Activity Logs æ•°é‡
   ```bash
   php artisan tinker --execute="echo \App\Models\ActivityLog::count();"
   ```

2. æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
   ```bash
   df -h
   ```

3. æ£€æŸ¥ PHP-FPM è¿›ç¨‹çŠ¶æ€
   ```bash
   systemctl status php8.3-fpm
   ```

### æ‰‹åŠ¨æ¸…ç†æ—¥å¿—ï¼ˆå¦‚éœ€è¦ï¼‰
```bash
# æ¸…ç†90å¤©å‰çš„æ—¥å¿—
php artisan activity-logs:clean --days=90

# æ¸…ç†30å¤©å‰çš„æ—¥å¿—ï¼ˆæ›´æ¿€è¿›ï¼‰
php artisan activity-logs:clean --days=30
```

### éªŒè¯å®šæ—¶ä»»åŠ¡
```bash
# æŸ¥çœ‹å®šæ—¶ä»»åŠ¡åˆ—è¡¨
php artisan schedule:list

# æ‰‹åŠ¨æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼ˆæµ‹è¯•ï¼‰
php artisan schedule:run
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å®šæ—¶ä»»åŠ¡éœ€è¦ Cron æ”¯æŒ**
   - ç¡®ä¿æœåŠ¡å™¨å·²é…ç½® Cron
   - æ·»åŠ ä»¥ä¸‹è¡Œåˆ° crontabï¼š
     ```bash
     * * * * * cd /var/www/oa && php artisan schedule:run >> /dev/null 2>&1
     ```

2. **PHP-FPM è¿›ç¨‹æ•°**
   - å½“å‰è®¾ç½®ä¸º10ä¸ªï¼Œå¦‚æœæœåŠ¡å™¨å†…å­˜å……è¶³ï¼Œå¯ä»¥è¿›ä¸€æ­¥å¢åŠ 
   - ç›‘æ§å®é™…ä½¿ç”¨æƒ…å†µï¼Œæ ¹æ®éœ€æ±‚è°ƒæ•´

3. **æ–‡ä»¶ä¸Šä¼ é™åˆ¶**
   - å½“å‰è®¾ç½®ä¸º10Mï¼Œå¦‚æœä¸šåŠ¡éœ€è¦æ›´å¤§æ–‡ä»¶ï¼Œå¯ä»¥ç»§ç»­è°ƒæ•´
   - æ³¨æ„ï¼š`post_max_size` å¿…é¡»å¤§äº `upload_max_filesize`

## ğŸ“ é…ç½®æ–‡ä»¶ä½ç½®

- PHP é…ç½®ï¼š`/etc/php/8.3/fpm/php.ini`
- PHP-FPM é…ç½®ï¼š`/etc/php/8.3/fpm/pool.d/www.conf`
- æ¸…ç†å‘½ä»¤ï¼š`app/Console/Commands/CleanOldActivityLogs.php`
- å®šæ—¶ä»»åŠ¡ï¼š`bootstrap/app.php`

## âœ… éªŒè¯å‘½ä»¤

```bash
# éªŒè¯ PHP é…ç½®
php -i | grep -E "memory_limit|max_execution_time|post_max_size|upload_max_filesize"

# éªŒè¯ PHP-FPM é…ç½®
grep -E "^pm.max_children|^pm.start_servers" /etc/php/8.3/fpm/pool.d/www.conf

# éªŒè¯å®šæ—¶ä»»åŠ¡
php artisan schedule:list

# æµ‹è¯•æ¸…ç†å‘½ä»¤
php artisan activity-logs:clean --days=90
```

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´ï¼š** 2025-11-25  
**æ‰€æœ‰é…ç½®å·²ç”Ÿæ•ˆï¼Œç³»ç»Ÿå·²ä¼˜åŒ–å®Œæˆï¼** âœ…


